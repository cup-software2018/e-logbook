{% extends 'base.html' %}

{% block title %}
    {{ logbook.name }} | {{ current_date|date:"Y-m-d" }}
{% endblock %}

{% block nav_buttons %}
<div class="d-flex align-items-center bg-light rounded px-1 py-1 ms-2" style="gap: 2px;">
    
    <a href="?date={{ prev_date }}&search={{ search_query }}" 
       class="btn btn-sm btn-link text-secondary p-0 px-2" title="Previous Date">
        <i class="fas fa-chevron-left"></i>
    </a>

    <a href="{% url 'elog:log_list' logbook.id %}" 
       class="btn btn-sm btn-link text-dark p-0 px-2" title="Latest Logs">
        <i class="fas fa-calendar-day"></i>
    </a>

    <a href="?date={{ next_date }}&search={{ search_query }}" 
       class="btn btn-sm btn-link text-secondary p-0 px-2" title="Next Date">
        <i class="fas fa-chevron-right"></i>
    </a>

</div>
{% endblock %}

{% block header_center %}
<div class="d-flex align-items-center justify-content-center gap-3">
    
    <h5 class="m-0 fw-bold text-white" style="letter-spacing: 0.5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
        {{ logbook.name }}
    </h5>
    
    <span class="text-white-50 mx-2">|</span>

    {% if search_query %}
        <span class="badge bg-warning text-dark shadow-sm">
            <i class="fas fa-search me-1"></i> Result: "{{ search_query }}"
        </span>
        <a href="{% url 'elog:log_list' logbook.id %}" class="btn btn-sm btn-outline-light py-0 border-0" style="font-size: 0.8rem;">
            <i class="fas fa-times-circle"></i> Clear
        </a>
    {% else %}
        <div class="d-flex align-items-center position-relative">
            <input type="date" value="{{ current_date|date:'Y-m-d' }}" 
                   class="form-control form-control-sm bg-dark text-white border-secondary shadow-sm"
                   style="width: 130px; font-size: 0.9rem;"
                   onchange="location.href='?date=' + this.value">
            
            {% if current_date|date:"Y-m-d" != today_date|date:"Y-m-d" %}
            <a href="{% url 'elog:log_list' logbook.id %}" 
               class="position-absolute start-100 translate-middle-y ms-2 badge bg-danger text-decoration-none shadow-sm" 
               style="top: 50%;" title="Go to Today">
                LIVE
            </a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block header_search %}{% endblock %}

{% block action_buttons %}
<div class="d-flex align-items-center gap-3">

    {% if can_write %}
    <a href="{% url 'elog:log_create' logbook.id %}" class="btn btn-primary btn-sm px-3 fw-bold shadow-sm rounded-pill">
        <i class="fas fa-pen me-2"></i>New Entry
    </a>
    {% endif %}

    <form action="{% url 'elog:log_list' logbook.id %}" method="GET" class="d-flex align-items-center" style="max-width: 200px;">
        <div class="input-group input-group-sm">
            <span class="input-group-text bg-dark border-secondary text-secondary">
                <i class="fas fa-search"></i>
            </span>
            <input type="text" name="search" value="{{ search_query|default:'' }}" 
                   class="form-control bg-dark text-white border-secondary" 
                   placeholder="Search..." aria-label="Search">
        </div>
    </form>

    <a href="{% url 'elog:export_logs_pdf' logbook.id %}?date={{ current_date|date:'Y-m-d' }}" 
       class="btn btn-sm btn-outline-danger shadow-sm" title="Export Daily Logs to PDF">
        <i class="fas fa-file-pdf fa-lg"></i>
    </a>

</div>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    
    {% for log in logs %}
    <article class="card mb-4 shadow-sm border-0">
        
        <div class="card-header bg-light d-flex justify-content-between align-items-center py-2 border-bottom">
            <div class="header-left d-flex align-items-center">
                <span class="badge bg-secondary me-2 shadow-sm" style="font-family: 'Courier New', monospace; font-size: 0.9em; letter-spacing: -0.5px;">
                    {{ log.created_at|date:"H:i:s" }}
                </span>
                <span class="fw-bold text-dark fs-6">{{ log.user.username }}</span>
            </div>
            
            <div class="button-group">
                <a href="{% url 'elog:log_comment' logbook.id log.id %}" class="text-secondary me-2 nav-btn p-1" title="Add Comment">
                    <i class="fas fa-comment-dots"></i>
                </a>

                {% if log.user == user or logbook.owner == user %}
                <a href="{% url 'elog:log_edit' logbook.id log.id %}" class="text-primary me-2 nav-btn p-1" title="Edit Log">
                    <i class="fas fa-edit"></i>
                </a>
                <a href="javascript:void(0);" 
                   onclick="confirmDelete('{% url 'elog:log_delete' logbook.id log.id %}')"
                   class="text-danger nav-btn p-1" title="Delete Log">
                    <i class="fas fa-trash-can"></i>
                </a>
                {% endif %}
            </div>
        </div>

        <div class="card-body">
            <div class="content-html mb-3 text-break" style="font-size: 1.05rem; line-height: 1.6;">
                {{ log.content_html|safe }}
            </div>
            
            {% if log.images.exists %}
            <div class="image-gallery d-flex flex-wrap gap-2 mt-3 p-2 bg-light rounded">
                {% for img in log.images.all %}
                <div class="image-wrapper position-relative shadow-sm" 
                     style="width: {{ img.width }}px; max-width: 100%;">
                    <img src="{{ img.image.url }}" class="img-fluid rounded border bg-white" 
                         onclick="openModal(this.src)" 
                         style="cursor: pointer; transition: transform 0.2s;"
                         onmouseover="this.style.transform='scale(1.02)'"
                         onmouseout="this.style.transform='scale(1.0)'"
                         title="Click to enlarge">
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        {% if log.comments.exists %}
        <div class="card-footer bg-white border-top border-light pt-0 pb-3">
            <div class="comment-section p-3 bg-light rounded mt-2 border border-light">
                <h6 class="text-muted small fw-bold mb-2 ps-1"><i class="fas fa-comments me-1"></i>Comments</h6>
                
                {% for comment in log.comments.all %}
                <div class="comment-line py-1 border-bottom border-white d-flex align-items-start">
                    <span class="text-secondary fw-bold me-2" style="font-family: 'Courier New', monospace; font-size: 0.75rem; min-width: 65px;">
                        {{ comment.created_at|date:"H:i:s" }}
                    </span>
                    <div class="lh-sm">
                        <span class="text-dark small">{{ comment.content }}</span>
                        <span class="text-muted ms-1 fst-italic" style="font-size: 0.75rem;">
                            - {{ comment.user.username }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </article>
    
    {% empty %}
    <div class="text-center py-5 mt-4">
        <div class="text-muted opacity-50 mb-3">
            <i class="fas fa-book-open fa-4x"></i>
        </div>
        <h5 class="text-secondary fw-bold">No entries found for this date.</h5>
        <p class="text-muted">Date: {{ current_date|date:"Y-m-d" }}</p>
        
        {% if can_write %}
        <div class="mt-4">
             <a href="{% url 'elog:log_create' logbook.id %}" class="btn btn-primary rounded-pill px-4 shadow-sm">
                <i class="fas fa-pen me-2"></i>Start Writing
             </a>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_script %}
<script>
    function confirmDelete(deleteUrl) {
        if (confirm("Are you sure you want to delete this log?\n\nWarning: Deleted data cannot be recovered.")) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = deleteUrl;

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = '{{ csrf_token }}';

            form.appendChild(csrfInput);
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}