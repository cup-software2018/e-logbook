{% extends 'base.html' %}

{% block title %}
    {{ logbook.name }} | {{ current_date|date:"Y-m-d" }}
{% endblock %}

{% block nav_buttons %}
<div class="d-flex align-items-center bg-light rounded px-1 py-1 ms-2" style="gap: 2px;">
    
    {% if prev_date %}
        <a href="?date={{ prev_date }}" 
           class="btn btn-sm btn-link text-secondary p-0 px-2" 
           title="Go to {{ prev_date }}">
            <i class="fas fa-chevron-left"></i>
        </a>
    {% else %}
        <span class="btn btn-sm btn-link text-muted p-0 px-2 disabled" 
              title="No older logs" style="cursor: default; opacity: 0.3;">
            <i class="fas fa-chevron-left"></i>
        </span>
    {% endif %}

    <a href="{% url 'elog:log_list' logbook.id %}" 
       class="btn btn-sm btn-link text-dark p-0 px-2" title="Latest Logs">
        <i class="fas fa-calendar-day"></i>
    </a>

    {% if next_date %}
        <a href="?date={{ next_date }}" 
           class="btn btn-sm btn-link text-secondary p-0 px-2" 
           title="Go to {{ next_date }}">
            <i class="fas fa-chevron-right"></i>
        </a>
    {% else %}
        <span class="btn btn-sm btn-link text-muted p-0 px-2 disabled" 
              title="No newer logs" style="cursor: default; opacity: 0.3;">
            <i class="fas fa-chevron-right"></i>
        </span>
    {% endif %}

</div>
{% endblock %}

{% block header_center %}
<div class="d-flex align-items-center justify-content-center gap-3">
    
    <h5 class="m-0 fw-bold text-white" style="letter-spacing: 0.5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
        {{ logbook.name }}
    </h5>
    
    <span class="text-white-50 mx-2">|</span>

    {% if search_query %}
        <span class="badge bg-warning text-dark shadow-sm">
            <i class="fas fa-search me-1"></i> Result: "{{ search_query }}"
        </span>
        <a href="{% url 'elog:log_list' logbook.id %}" class="btn btn-sm btn-outline-light py-0 border-0" style="font-size: 0.8rem;">
            <i class="fas fa-times-circle"></i> Clear
        </a>
    {% else %}
        <div class="d-flex align-items-center position-relative">
            <input type="text" id="flatpickr-date" 
                value="{{ current_date|date:'Y-m-d' }}" 
                class="form-control form-control-sm bg-dark text-white border-secondary shadow-sm text-center"
                style="width: 130px; font-size: 0.9rem; cursor: pointer;"
                placeholder="Select Date" readonly>
    
            {% if current_date|date:"Y-m-d" != today_date|date:"Y-m-d" %}
            <a href="{% url 'elog:log_list' logbook.id %}" 
                class="position-absolute start-100 translate-middle-y ms-2 badge bg-danger text-decoration-none shadow-sm" 
                style="top: 50%;" title="Go to Today">
                LIVE
            </a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block header_search %}{% endblock %}

{% block action_buttons %}
<div class="d-flex align-items-center gap-3">

    <form action="{% url 'elog:log_list' logbook.id %}" method="GET" class="d-flex align-items-center" style="max-width: 200px;">
        <div class="input-group input-group-sm">
            <span class="input-group-text bg-dark border-secondary text-secondary">
                <i class="fas fa-search"></i>
            </span>
            <input type="text" name="search" value="{{ search_query|default:'' }}" 
                   class="form-control bg-dark text-white border-secondary" 
                   placeholder="Search..." aria-label="Search">
        </div>
    </form>

    <a href="{% url 'elog:export_logs_pdf' logbook.id %}?date={{ current_date|date:'Y-m-d' }}" 
       class="btn btn-sm btn-outline-danger shadow-sm" title="Export Daily Logs to PDF">
        <i class="fas fa-file-pdf fa-lg"></i>
    </a>

</div>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    
    {% for log in logs %}
    <article class="card mb-4 shadow-sm border-0" id="log-{{ log.id }}">
        
        <div class="card-header bg-light d-flex justify-content-between align-items-center py-2 border-bottom">
            <div class="header-left d-flex align-items-center">
                <span class="badge bg-secondary me-2 shadow-sm" style="font-family: 'Courier New', monospace; font-size: 0.9em; letter-spacing: -0.5px;">
                    {{ log.created_at|date:"H:i:s" }}
                </span>
                <span class="fw-bold text-dark fs-6">{{ log.user.username }}</span>
            </div>
            
            <div class="button-group">
                <a href="{% url 'elog:log_comment' logbook.id log.id %}" class="text-secondary me-2 nav-btn p-1" title="Add Comment">
                    <i class="fas fa-comment-dots"></i>
                </a>

                {% if log.user == user or logbook.owner == user %}
                <a href="{% url 'elog:log_edit' logbook.id log.id %}" class="text-primary me-2 nav-btn p-1" title="Edit Log">
                    <i class="fas fa-edit"></i>
                </a>
                <a href="javascript:void(0);" 
                   onclick="confirmDelete('{% url 'elog:log_delete' logbook.id log.id %}')"
                   class="text-danger nav-btn p-1" title="Delete Log">
                    <i class="fas fa-trash-can"></i>
                </a>
                {% endif %}
            </div>
        </div>

        <div class="card-body">
            <div class="content-html mb-3 text-break" style="font-size: 1.05rem; line-height: 1.6;">
                {{ log.content_html|safe }}
            </div>
            
            {% if log.images.exists %}
            <div class="image-gallery d-flex flex-wrap gap-2 mt-3 p-2 bg-light rounded">
                {% for img in log.images.all %}
                <div class="image-wrapper position-relative shadow-sm" 
                     style="width: {{ img.width }}px; max-width: 100%;">
                    <img src="{{ img.image.url }}" class="img-fluid rounded border bg-white" 
                         onclick="openModal(this.src)" 
                         style="cursor: pointer; transition: transform 0.2s;"
                         onmouseover="this.style.transform='scale(1.02)'"
                         onmouseout="this.style.transform='scale(1.0)'"
                         title="Click to enlarge">
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        {% if log.comments.exists %}
        <div class="card-footer bg-white border-top border-light pt-0 pb-3">
            <div class="comment-section p-3 bg-light rounded mt-2 border border-light">
                <h6 class="text-muted small fw-bold mb-2 ps-1"><i class="fas fa-comments me-1"></i>Comments</h6>
                
                {% for comment in log.comments.all %}
                <div class="comment-line py-1 border-bottom border-white d-flex align-items-start">
                    <span class="text-secondary fw-bold me-2" style="font-family: 'Courier New', monospace; font-size: 0.75rem; min-width: 65px;">
                        {{ comment.created_at|date:"H:i:s" }}
                    </span>
                    <div class="lh-sm">
                        <span class="text-dark small">{{ comment.content }}</span>
                        <span class="text-muted ms-1 fst-italic" style="font-size: 0.75rem;">
                            - {{ comment.user.username }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </article>
    
    {% empty %}
    <div class="text-center py-5 mt-4">
        <div class="text-muted opacity-50 mb-3">
            <i class="fas fa-book-open fa-4x"></i>
        </div>
        <h5 class="text-secondary fw-bold">No entries found for this date.</h5>
        <p class="text-muted">Date: {{ current_date|date:"Y-m-d" }}</p>
        
        {% if can_write %}
        <div class="mt-4">
             <a href="{% url 'elog:log_create' logbook.id %}" class="btn btn-primary rounded-pill px-4 shadow-sm">
                <i class="fas fa-pen me-2"></i>Start Writing
             </a>
        </div>
        {% endif %}
    </div>
    {% endfor %}

    {% if logs and can_write %}
    <div id="bottom-action-bar" class="d-flex justify-content-center mb-5 mt-4 pb-5">
        <a href="{% url 'elog:log_create' logbook.id %}" 
           class="btn btn-outline-primary fw-bold border-2 shadow-sm hover-effect rounded-pill"
           style="width: 200px;">
            <i class="fas fa-plus-circle me-2"></i> New Entry
        </a>
    </div>
    {% endif %}

    <div class="position-fixed bottom-0 end-0 p-4 d-flex flex-column gap-2" style="z-index: 1050;">
        <button onclick="scrollToTop()" class="btn btn-secondary rounded-circle shadow opacity-75 nav-float-btn" title="Go to Top">
            <i class="fas fa-arrow-up"></i>
        </button>
        <button onclick="scrollToBottom()" class="btn btn-secondary rounded-circle shadow opacity-75 nav-float-btn" title="Go to Bottom">
            <i class="fas fa-arrow-down"></i>
        </button>
    </div>

</div>
{% endblock %}

{% block extra_script %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
    /* Flatpickr: Dot for days with logs */
    .flatpickr-day.has-log::after {
        content: "";
        position: absolute;
        bottom: 2px;
        left: 0;
        right: 0;
        margin: 0 auto;
        width: 4px;
        height: 4px;
        background-color: #0d6efd; /* Bootstrap Primary */
        border-radius: 50%;
    }
    .flatpickr-day.has-log {
        font-weight: bold;
        color: #0d6efd;
    }
    .flatpickr-day.selected.has-log {
        color: #fff;
    }
    .flatpickr-day.selected.has-log::after {
        background-color: #fff;
    }

    /* Effects */
    .hover-effect:hover {
        background-color: #0d6efd;
        color: white;
        transform: translateY(-2px);
        transition: all 0.2s ease-in-out;
    }
    
    /* Floating Buttons */
    .nav-float-btn {
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    .nav-float-btn:hover {
        opacity: 1 !important;
        background-color: #0d6efd;
        color: white;
        transform: scale(1.1);
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // --- A. Anchor & Auto Scroll Logic ---
        const hash = window.location.hash;

        if (hash) {
            // Case 1: Anchor exists (#log-ID) -> Scroll to specific log
            const targetId = hash.substring(1);
            const targetElement = document.getElementById(targetId);
            
            if (targetElement) {
                setTimeout(() => {
                    targetElement.scrollIntoView({ behavior: 'auto', block: 'center' });
                    
                    targetElement.style.transition = "box-shadow 0.3s";
                    targetElement.style.boxShadow = "0 0 0 4px rgba(13, 110, 253, 0.3)";
                    setTimeout(() => {
                        targetElement.style.boxShadow = "";
                    }, 1500);
                }, 100); 
            }
        } else {
            // Case 2: No Anchor -> Scroll to Bottom
            const bottomBar = document.getElementById('bottom-action-bar');
            if (bottomBar) {
                setTimeout(() => {
                    bottomBar.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            } else {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }
        }

        // --- B. Flatpickr Logic ---
        const logDates = {{ log_dates|safe }}; // ['2023-01-01', ...]

        flatpickr("#flatpickr-date", {
            dateFormat: "Y-m-d",
            defaultDate: "{{ current_date|date:'Y-m-d' }}",
            disableMobile: "true",
            
            onChange: function(selectedDates, dateStr, instance) {
                window.location.href = '?date=' + dateStr;
            },

            onDayCreate: function(dObj, dStr, fp, dayElem) {
                const dateObj = dayElem.dateObj;
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;

                if (logDates.includes(formattedDate)) {
                    dayElem.classList.add("has-log");
                }
            }
        });
    });

    // --- C. Helper Functions ---
    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function scrollToBottom() {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function confirmDelete(deleteUrl) {
        if (confirm("Are you sure you want to delete this log?\n\nWarning: Deleted data cannot be recovered.")) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = deleteUrl;

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = '{{ csrf_token }}';

            form.appendChild(csrfInput);
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}